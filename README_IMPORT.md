# Импорт данных магазина через админку

## Быстрый запуск:

1. **Активация виртуального окружения:**
```bash
venv\Scripts\activate
```

2. **Установка зависимостей:**
```bash
pip install -r requirements.txt
```

3. **Миграции:**
```bash
python manage.py makemigrations
python manage.py migrate
```

4. **Создание суперпользователя:**
```bash
python manage.py createsuperuser
```

5. **Запуск сервера:**
```bash
python manage.py runserver
```

6. **Импорт данных (через терминал):**
```bash
python manage.py load_db ../data/shop1.yaml
```

## Использование админки:

1. **Перейдите по адресу:** `http://127.0.0.1:8000/admin/`

2. **Войдите под учетной записью администратора**

3. **В главном меню найдите пункт "Импорт данных"**

4. **Нажмите "Импорт данных" для открытия формы**

5. **Загрузите YAML-файл с данными магазина**

6. **Нажмите "Импортировать" для загрузки данных**

## Доступные файлы для импорта:

- `data/shop1.yaml` - Связной (смартфоны, аксессуары, телевизоры)
- `data/shop2.yaml` - M.Video (ноутбуки, планшеты, мониторы)
- `data/shop3.yaml` - Эльдорадо (бытовая техника)

## Структура YAML-файла:

```yaml
shop: Название магазина
categories:
  - id: №категории
    name: Название категории
goods:
  - id: №товара
    category: №категории
    model: Модель товара
    name: Название товара
    price: Цена
    price_rrc: Рекомендуемая цена
    quantity: Количество
    parameters:
      Название параметра: Значение
```

## Пример использования:

1. **Загрузка данных Связного:**
   - Выберите файл `data/shop1.yaml`
   - Нажмите "Импортировать"
   - Дождитесь сообщения об успешном импорте

2. **Загрузка данных M.Video:**
   - Выберите файл `data/shop2.yaml`
   - Нажмите "Импортировать"
   - Дождитесь сообщения об успешном импорте

## Что происходит при импорте:

- **Создается/обновляется магазин** с указанным названием
- **Обрабатываются категории** товаров
- **Загружаются товары** с параметрами
- **Старые данные для магазина удаляются**
- **Показывается сообщение об успешном импорте**

## Ошибки и решения:

1. **Ошибка: "Файл должен иметь расширение .yaml"**
   - Решение: Проверьте расширение файла

2. **Ошибка: "Некорректный формат YAML-файла"**
   - Решение: Проверьте структуру YAML файла

3. **Ошибка: "Ошибка при импорте данных"**
   - Решение: Проверьте корректность данных в файле

## Важные моменты:

- **Один файл = один магазин**
- **Данные заменяют существующие** для этого магазина
- **Поддерживаются только файлы .yaml**
- **Кодировка файла должна быть UTF-8**

## Редактирование статуса заказа (для администраторов)

### API метод:
```
PUT /api/v1/orders/{order_id}/status/
```

### Описание:
Позволяет администратору изменить статус любого заказа.

### Параметры запроса:
```json
{
    "state": "delivered"
}
```

### Доступные статусы:
- `basket` - корзина
- `new` - новый
- `confirmed` - подтвержден
- `assembled` - собран
- `sent` - отправлен
- `delivered` - доставлен
- `canceled` - отменен

### Пример использования:
```bash
curl -X PUT http://127.0.0.1:8000/api/v1/orders/6/status/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{"state": "delivered"}'
```

### Ответ:
```json
{
    "message": "Статус заказа обновлен на: Доставлен",
    "order_id": 6,
    "new_state": "delivered",
    "new_state_display": "Доставлен"
}
```

### Требования к доступу:
- Только для пользователей с правами администратора
- Аутентификация обязательна

### Ограничения:
- Статус должен быть одним из допустимых значений
- Заказ должен существовать в системе

## Запуск тестов

### Запуск всех тестов:
```bash
python manage.py test backend.tests
```

### Запуск конкретных тестов:
```bash
python manage.py test backend.tests.OrderStatusUpdateTests
```

### Запуск с подробным выводом:
```bash
python manage.py test backend.tests --verbosity=2
```

### Запуск с покрытием кода:
```bash
coverage run --source=backend manage.py test backend.tests
coverage report
```

### Тестирование API методов:
```bash
# Тестирование обновления статуса заказа
curl -X PUT http://127.0.0.1:8000/api/v1/orders/1/status/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{"state": "confirmed"}'
```

### Проверка логики статусов:
- `basket` -> `new` -> `confirmed` -> `assembled` -> `sent` -> `delivered`
- Любой статус -> `canceled`
- `basket` -> `canceled`

### Доступные статусы:
```python
STATE_CHOICES = [
    ('basket', 'Корзина'),
    ('new', 'Новый'),
    ('confirmed', 'Подтвержден'),
    ('assembled', 'Собран'),
    ('sent', 'Отправлен'),
    ('delivered', 'Доставлен'),
    ('canceled', 'Отменен'),
]
```